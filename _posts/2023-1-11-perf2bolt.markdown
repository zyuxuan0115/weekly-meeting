---
layout: post
title:  "2022-1-11 extracting reversed BAT"
date:   2023-1-11 10:53:46 -0500
categories: cont-opt 
---
### Recap of last meeting
- We found an issue when Ocolos performed code replacement
  + `mmap()` returns `mmap failed: File exists`.
    * this is because the code replacement location overlap with the heap.
    * our hypothesis is that `mysqld.bolt`'s BOTLed text setion grows too large because of the insertion of <strong>Reversed BAT</strong>.
  + our solution
    * insert the map relation of <strong>the starting address of original function</strong> -> <strong>the starting address of BOLTed function</strong> (I named it <strong>FuncMapTable</strong>), instead of the whole <strong>Reversed BAT</strong>.
    * when perf2bolt runs, it computes the <strong>Reversed BAT</strong> from <strong>FuncMapTable</strong> and <strong>BAT</strong>

### Change the Reversed BAT into FuncMapTable
- After I change the <strong>Reversed BAT</strong> into <strong>FuncMapTable</strong>
  + the BOLTed text section is still of the same size as the BOLTed text section when we inserted <strong> Reversed BAT</strong>
- The text sction getting from `proc/PID/maps` is shown as follows:
  + `mysqld.bolt` produced by [my modified llvm github repo](https://github.com/zyuxuan0115/llvm-project)'s BOLT
    * <strong>without</strong> `--enable-bat` 
    * <strong>without</strong> `--enable-func-map-table`
```
1 00200000-01b22000 r--p 00000000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
2 01b22000-038cb000 r-xp 01921000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
3 038cb000-03a40000 r--p 036c9000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
4 03a40000-03dcb000 rw-p 0383d000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
5 03dcb000-042fd000 rw-p 00000000 00:00 0
6 04400000-069db000 r-xp 04200000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
7 080a5000-0a9cc000 rw-p 00000000 00:00 0                  [heap]
```
  + `mysqld.bolt` produced by [my modified llvm github repo](https://github.com/zyuxuan0115/llvm-project)'s BOLT  
    * <strong>with</strong> `--enable-bat` 
    * <strong>without</strong> `--enable-func-map-table`
```
1 00200000-01b22000 r--p 00000000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
2 01b22000-038cb000 r-xp 01921000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
3 038cb000-03a40000 r--p 036c9000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
4 03a40000-03dcb000 rw-p 0383d000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
5 03dcb000-042fd000 rw-p 00000000 00:00 0
6 04400000-069db000 r-xp 04200000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
7 06c60000-09588000 rw-p 00000000 00:00 0                  [heap]
``` 
  + `mysqld.bolt` produced by [my modified llvm github repo](https://github.com/zyuxuan0115/llvm-project)'s BOLT  
    * <strong>with</strong> `--enable-bat` 
    * <strong>with</strong> `--enable-func-map-table`
```
1 00200000-01b22000 r--p 00000000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
2 01b22000-038cb000 r-xp 01921000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
3 038cb000-03a40000 r--p 036c9000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
4 03a40000-03dcb000 rw-p 0383d000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
5 03dcb000-042fd000 rw-p 00000000 00:00 0
6 04400000-069db000 r-xp 04200000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
7 08657000-0af7e000 rw-p 00000000 00:00 0                  [heap]
```
  + `mysqld.bolt` produced by [my modified llvm github repo](https://github.com/zyuxuan0115/llvm-project)'s BOLT  
    * <strong>with</strong> `--enable-bat` 
    * <strong>with Reversed BAT</strong> (This is the data from last meeting) 
```
1 00200000-01b22000 r--p 00000000 09:00 126364470        /usr/local/mysql/bin/mysqld.bolt
2 01b22000-038cb000 r-xp 01921000 09:00 126364470        /usr/local/mysql/bin/mysqld.bolt
3 038cb000-03a40000 r--p 036c9000 09:00 126364470        /usr/local/mysql/bin/mysqld.bolt
4 03a40000-03dcb000 rw-p 0383d000 09:00 126364470        /usr/local/mysql/bin/mysqld.bolt
5 03dcb000-042fd000 rw-p 00000000 00:00 0
6 04400000-069db000 r-xp 04200000 09:00 126364470        /usr/local/mysql/bin/mysqld.bolt
7 071a0000-09ac8000 rw-p 00000000 00:00 0                [heap]
```

### Why is this the case?
- `mysqld.bolt` produced by [Facebook's BOLT github repo](https://github.com/facebookincubator/BOLT) 
  + <strong>with</strong> `--enable-bat` 
  + git hash = `88c70afe9d388ad430cc150cc158641701397f70` 
  + This version is used by OCOLOS
```
  1 00200000-01b22000 r--p 00000000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
  2 01b22000-038cb000 r-xp 01921000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
  3 038cb000-03a40000 r--p 036c9000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
  4 03a40000-03dcb000 rw-p 0383d000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
  5 03dcb000-042fd000 rw-p 00000000 00:00 0
  6 04400000-04b1b000 r-xp 04200000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
  7 06487000-08dae000 rw-p 00000000 00:00 0                  [heap]
```
- `mysqld.bolt` produced by [Facebook's BOLT github repo](https://github.com/facebookincubator/BOLT) 
  + <strong>without</strong> `--enable-bat` 
  + git hash = `88c70afe9d388ad430cc150cc158641701397f70` 
  + This version is used by OCOLOS
```
  1 00200000-01b22000 r--p 00000000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
  2 01b22000-038cb000 r-xp 01921000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
  3 038cb000-03a40000 r--p 036c9000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
  4 03a40000-03dcb000 rw-p 0383d000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
  5 03dcb000-042fd000 rw-p 00000000 00:00 0
  6 04400000-04b1b000 r-xp 04200000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
  7 05c93000-085ba000 rw-p 00000000 00:00 0                  [heap]
```
<br/><br/>

***

<br/><br/>
- `mysqld.bolt` produced by [the latest update of llvm's BOLT github repo](https://github.com/llvm/llvm-project)  
  + <strong>with</strong> `--enable-bat` 
  + git hash = `d86f1a982e8423a2ae5a424906f6960576c35606`
```
  1 00200000-01b22000 r--p 00000000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
  2 01b22000-038cb000 r-xp 01921000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
  3 038cb000-03a40000 r--p 036c9000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
  4 03a40000-03dcb000 rw-p 0383d000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
  5 03dcb000-042fd000 rw-p 00000000 00:00 0
  6 04400000-069db000 r-xp 04200000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
  7 08969000-0b291000 rw-p 00000000 00:00 0                  [heap]
```
- `mysqld.bolt` produced by [the latest update of llvm's BOLT github repo](https://github.com/llvm/llvm-project)
  + <strong>without</strong> `--enable-bat` 
  + git hash = `d86f1a982e8423a2ae5a424906f6960576c35606`
```
  1 00200000-01b22000 r--p 00000000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
  2 01b22000-038cb000 r-xp 01921000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
  3 038cb000-03a40000 r--p 036c9000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
  4 03a40000-03dcb000 rw-p 0383d000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
  5 03dcb000-042fd000 rw-p 00000000 00:00 0
  6 04400000-069db000 r-xp 04200000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
  7 07208000-09b30000 rw-p 00000000 00:00 0                  [heap]
```
<br/><br/>

***

<br/><br/>
- `mysqld.bolt` produced by [the latest update of Facebook's BOLT github repo](https://github.com/facebookincubator/BOLT) 
  + <strong>with</strong> `--enable-bat` 
  + git hash = `56ff67ccd90702d87a44c7e60abe3c4986855493`
```
  1 00200000-01b22000 r--p 00000000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
  2 01b22000-038cb000 r-xp 01921000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
  3 038cb000-03a40000 r--p 036c9000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
  4 03a40000-03dcb000 rw-p 0383d000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
  5 03dcb000-042fd000 rw-p 00000000 00:00 0
  6 04400000-04b1b000 r-xp 04200000 09:00 126364470          /usr/local/mysql/bin/mysqld.bolt
  7 06081000-089a8000 rw-p 00000000 00:00 0                  [heap]
```
- `mysqld.bolt` produced by [the latest update of Facebook's BOLT github repo](https://github.com/facebookincubator/BOLT) 
  + <strong>without</strong> `--enable-bat` 
  + git hash = `56ff67ccd90702d87a44c7e60abe3c4986855493`
```
  1 00200000-01b22000 r--p 00000000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
  2 01b22000-038cb000 r-xp 01921000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
  3 038cb000-03a40000 r--p 036c9000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
  4 03a40000-03dcb000 rw-p 0383d000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
  5 03dcb000-042fd000 rw-p 00000000 00:00 0
  6 04400000-04b1b000 r-xp 04200000 09:00 126364472          /usr/local/mysql/bin/mysqld.bolt
  7 051a6000-07acd000 rw-p 00000000 00:00 0                  [heap]
```

### The further explanation


### 
![before](/assets/2023-01-15/before.png)
![after](/assets/2023-01-15/after.png)

### The performance of OCOLOS on cascade52
- Throughput (transactions/sec) reported by `sysbench` 

|   | original | Ocolos | offline BOLT | 
| :----: |:----:|   :----:| :----: | 
| 1 | 5581.39 | 7734.36 | 9205.93 | 
| 2 | 5527.57 | 9008.29 | 9199.31 |
| 3 | 5559.51 | 7715.76 | 8989.01 |
| 4 | 5555.36 | 7780.07 | 9195.17 |
| 5 | 5625.01 | 7652.45 | 9115.19 |
| 6 | 5603.49 | 8226.59 | 8942.93 |
| 7 | 5626.44 | 7807.37 | 9191.91 |
| 8 | 5626.28 | 7730.24 | 9212.42 |
| 9 | 5615.61 | 7556.94 | 9153.43 |
| 10 | 5517.51 | 8141.70 | 9192.65 |